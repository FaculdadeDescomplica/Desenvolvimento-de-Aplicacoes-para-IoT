#include <WiFi.h>
#include <MQTT.h>

const char* ssid = "Wokwi-GUEST";
const char* password = "";

WiFiClient net;
MQTTClient client;

const int soundSensor = 34; 
const int ledPin = 2;     
int ledState = LOW;
unsigned long lastClap = 0;

void connect() {
  Serial.print("Conectando WiFi...");
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println(" conectado!");

  Serial.print("Conectando MQTT...");
  while (!client.connect("esp32-clapper")) {
    Serial.print(".");
    delay(1000);
  }
  Serial.println(" conectado!");
}

void setup() {
  pinMode(ledPin, OUTPUT);
  Serial.begin(115200);

  WiFi.begin(ssid, password);
  client.begin("broker.emqx.io", net); // pode usar o broker interno ou externo
  connect();
}

void loop() {
  client.loop();

  int soundValue = analogRead(soundSensor);

  if (soundValue > 2000) {
    unsigned long currentMillis = millis();
    if (currentMillis - lastClap > 300) {
      ledState = !ledState;
      digitalWrite(ledPin, ledState);
      
      if (ledState) {
        client.publish("clapper/led", "LED ON");
      } else {
        client.publish("clapper/led", "LED OFF");
      }
      
      Serial.print("Clap detectado! LED agora est√°: ");
      Serial.println(ledState ? "LIGADO" : "DESLIGADO");
      lastClap = currentMillis;
    }
  }
}
